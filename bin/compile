#!/usr/bin/env bash

# This script builds documentations for a python application using Sphinx.
#
#     $ bin/compile <build-dir> <docs-dir>

# Fail fast and hard
set -eo pipefail

# Hack to use Python in /usr/local/ rather than the .heroku/venv/
export PATH=/usr/local/bin:$PATH

# Paths
BIN_DIR=$(cd $(dirname $0); pwd)
ROOT_DIR=$(dirname $BIN_DIR)
BUILD_DIR=$1
DOCS_DIR=$2

# Python version
PYTHON_VERSION="2.7.2"
PYTHON_EXE="python2.7"

# Unset environment variables
unset GIT_DIR PYTHONHOME PYTHONPATH LD_LIBRARY_PATH LIBRARY_PATH

# Make these variables available in sourced scripts
export BUILD_DIR BIN_DIR BIN_DIR

cd $BUILD_DIR

# Check whether to use pip or disutils
if [ ! -f requirements.txt ]; then
  echo "No requirements.txt provided; assuming dist package."
  echo "-e ." > requirements.txt
fi

# Create virtualenv
echo "Preparing Python interpreter ($PYTHON_VERSION)"
echo "Creating Virtualenv version $(virtualenv --version)"
virtualenv --python $PYTHON_EXE --distribute --never-download venv

# Pylibmc support
source $BIN_DIR/steps/pylibmc

# Activate the virtualenv
echo "Activating virtualenv"
source venv/bin/activate

# Install dependencies with pip
pip install --use-mirrors -r requirements.txt --exists-action=w

# Install Sphinx
pip install --use-mirrors sphinx

# Build html docs
cd $DOCS_DIR
make html

deactivate
